<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Video Compressor (FFmpeg.wasm)</title>

  <!-- Basic styles; keep or swap with your own -->
  <style>
    :root { --brand:#00bfa6; --bg:#0e1217; --panel:#141a21; --text:#e5eef7; --muted:#98a2b3; }
    body { margin:0; font:15px system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial; color:var(--text); background:var(--bg);}
    .wrap{ max-width:980px; margin:24px auto; padding:16px;}
    .card{ background:var(--panel); border:1px solid #223346; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden;}
    .hd{ display:flex; align-items:center; gap:10px; padding:16px; background:linear-gradient(145deg,var(--brand),#2388ff); font-weight:700;}
    .bd{ padding:16px;}
    label{ font-weight:600; font-size:13px; color:var(--muted);}
    select,input[type="range"],input[type="number"],input[type="file"],button{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #223346; background:#0b141b;
      color:var(--text); outline:0; box-sizing:border-box;
    }
    input[type="range"]{ height:32px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .hint{ font-size:12px; color:var(--muted);}
    .toggle{ display:flex; gap:8px; margin:8px 0 12px;}
    .toggle button{ background:transparent; border:1px solid #223346; color:var(--muted); padding:8px 10px; border-radius:8px; cursor:pointer;}
    .toggle button.active{ background:var(--brand); border-color:transparent; color:#08121a; }
    .btn{ background:var(--brand); color:#08121a; font-weight:700; border:0; cursor:pointer;}
    .btn:disabled{ opacity:.5; cursor:not-allowed;}
    .progress{ height:10px; background:#0b1a28; border:1px solid #223346; border-radius:999px; overflow:hidden; margin-top:8px;}
    .progress > div{ height:100%; width:0; background:linear-gradient(90deg,var(--brand),#2388ff); transition:width .2s ease;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .out{ display:none; align-items:center; gap:10px; padding:10px;}
    .out a{ color:#a2e7ff; text-decoration:none; }
    .section { margin:14px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">Simple Video Compressor — FFmpeg.wasm</div>
      <div class="bd">
        <div class="section">
          <label>Source Video</label>
          <input id="file" type="file" accept="video/*" />
          <p class="hint">MP4/MOV/WebM etc. All processing stays in your browser.</p>
        </div>

        <div class="section">
          <label>Mode</label>
          <div class="toggle">
            <button id="mode-simple" class="active">Simple</button>
            <button id="mode-adv">Advanced</button>
          </div>
        </div>

        <!-- SIMPLE -->
        <div id="simple">
          <div class="section row">
            <div>
              <label>Preset</label>
              <select id="preset">
                <option value="libx264-crf23">H.264 (CRF 23)</option>
                <option value="libx265-crf28">H.265 (CRF 28)</option>
                <option value="libvpx-vp9-crf33">VP9 (CRF 33)</option>
              </select>
            </div>
            <div>
              <label>Format</label>
              <select id="format">
                <option value="mp4">MP4</option>
                <option value="webm">WebM</option>
              </select>
            </div>
          </div>

          <div class="section">
            <label>Quality (CRF) — lower = better</label>
            <input id="crf" type="range" min="18" max="40" step="1" value="28" />
            <div class="hint">Typical 18–30. Default depends on preset. <span id="crf-val" class="mono">28</span></div>
          </div>

          <div class="section row">
            <div>
              <label>Resolution</label>
              <select id="scale">
                <option value="">Keep original</option>
                <option value="1280:720">720p</option>
                <option value="854:480">480p</option>
                <option value="640:360">360p</option>
              </select>
            </div>
            <div>
              <label>Frame Rate</label>
              <select id="fps">
                <option value="">Keep</option>
                <option>24</option>
                <option>25</option>
                <option>30</option>
              </select>
            </div>
          </div>

          <div class="section row">
            <div>
              <label>Audio</label>
              <select id="audio">
                <option value="aac-96k">Encode AAC 96k</option>
                <option value="copy">Copy</option>
                <option value="none">Remove</option>
              </select>
            </div>
            <div>
              <label>—</label>
              <button id="start" class="btn">Start Compress</button>
            </div>
          </div>

          <div class="section">
            <div id="status" class="hint mono">Idle.</div>
            <div class="progress"><div id="bar"></div></div>
          </div>

          <details id="cmdWrap" class="section mono" style="display:none;">
            <summary>Show FFmpeg command</summary>
            <pre id="cmd" style="white-space:pre-wrap"></pre>
          </details>

          <div id="out" class="out section">
            <span>✅ Done:</span>
            <a id="download" href="#" download>Download output</a>
            <span id="size" class="hint"></span>
          </div>
        </div>

        <!-- ADVANCED -->
        <div id="advanced" style="display:none;">
          <div class="section">
            <label>Custom command (without “ffmpeg”)</label>
            <input id="adv-cmd" type="text" placeholder='-i input.mp4 -c:v libx264 -crf 23 output.mp4' />
          </div>
          <button id="run-adv" class="btn">Run Advanced</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Your local libraries (order matters) -->
  <script src="./jquery-3.7.1.min.js"></script>
  <script src="./bootstrap.bundle.min.js"></script>
  <script src="./sweetalert2.min.js"></script>
  <script src="./ffmpeg.min.js"></script>

  <script>
    // Pull createFFmpeg & fetchFile from the UMD global exposed by ffmpeg.min.js
    const { createFFmpeg, fetchFile } = FFmpeg;

    const els = {
      file: $('#file')[0],
      start: $('#start')[0],
      modeSimple: $('#mode-simple')[0],
      modeAdv: $('#mode-adv')[0],
      simple: $('#simple')[0],
      advanced: $('#advanced')[0],
      crf: $('#crf')[0],
      crfVal: $('#crf-val')[0],
      preset: $('#preset')[0],
      format: $('#format')[0],
      scale: $('#scale')[0],
      fps: $('#fps')[0],
      audio: $('#audio')[0],
      status: $('#status')[0],
      bar: $('#bar')[0],
      out: $('#out')[0],
      dl: $('#download')[0],
      size: $('#size')[0],
      cmdWrap: $('#cmdWrap')[0],
      cmd: $('#cmd')[0],
      runAdv: $('#run-adv')[0],
      advCmd: $('#adv-cmd')[0]
    };

    let ffmpeg;
    let coreLoaded = false;

    function setMode(which){
      if(which==='simple'){
        els.modeSimple.classList.add('active');
        els.modeAdv.classList.remove('active');
        els.simple.style.display = '';
        els.advanced.style.display = 'none';
      }else{
        els.modeAdv.classList.add('active');
        els.modeSimple.classList.remove('active');
        els.simple.style.display = 'none';
        els.advanced.style.display = '';
      }
    }

    els.modeSimple.onclick = ()=>setMode('simple');
    els.modeAdv.onclick = ()=>setMode('adv');

    // Live CRF label
    els.crf.addEventListener('input', ()=> els.crfVal.textContent = els.crf.value);

    function logStatus(msg){ els.status.textContent = msg; }
    function setProgress(ratio){
      els.bar.style.width = (Math.max(0, Math.min(1, ratio))*100) + '%';
    }

    async function ensureFFmpeg(){
      if(coreLoaded) return;
      ffmpeg = createFFmpeg({ log: false, corePath: './ffmpeg-core.js', progress: ({ ratio }) => setProgress(ratio || 0) });
      logStatus('Loading FFmpeg core (local)…');
      try {
        await ffmpeg.load();
      } catch (e) {
        console.error(e);
        logStatus('Failed to load local core. Falling back to CDN…');
        try {
          ffmpeg = createFFmpeg({ log: false, corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js', progress: ({ ratio }) => setProgress(ratio || 0) });
          await ffmpeg.load();
        } catch (e2) {
          console.error(e2);
          logStatus('FFmpeg failed to load.');
          Swal.fire('Could not load FFmpeg core', 'Place ffmpeg-core.js / ffmpeg-core.wasm / ffmpeg-core.worker.js next to index.html, or allow CDN access.', 'error');
          throw e2;
        }
      }
      coreLoaded = true;
      logStatus('FFmpeg ready.');
    }

    // Build args for "Simple" mode
    function buildArgsSimple(inputName, outputName){
      const [vCodec, defaultCrf] = (()=>{
        switch(els.preset.value){
          case 'libx265-crf28': return ['libx265', 28];
          case 'libvpx-vp9-crf33': return ['libvpx-vp9', 33];
          default: return ['libx264', 23];
        }
      })();

      const crfVal = els.crf.value || defaultCrf;
      const args = ['-i', inputName, '-y'];

      // Video codec + quality
      args.push('-c:v', vCodec);
      if(vCodec === 'libvpx-vp9'){ args.push('-b:v','0'); } // recommended for VP9 CRF mode
      args.push('-crf', String(crfVal));

      // Optional scale
      if(els.scale.value){
        args.push('-vf', `scale=${els.scale.value}`);
      }
      // Optional fps
      if(els.fps.value){
        args.push('-r', els.fps.value);
      }
      // Audio
      if(els.audio.value === 'none'){
        args.push('-an');
      } else if(els.audio.value === 'copy'){
        args.push('-c:a', 'copy');
      } else {
        // aac-96k
        args.push('-c:a', 'aac', '-b:a', '96k');
      }

      // Format/container
      const ext = els.format.value.toLowerCase() === 'webm' ? 'webm' : 'mp4';
      const out = outputName.endsWith(`.${ext}`) ? outputName : `output.${ext}`;
      args.push(out);
      return { args, out };
    }

    function showCmd(args){
      els.cmd.textContent = ['ffmpeg'].concat(args.map(a => a.includes(' ') ? `"${a}"` : a)).join(' ');
      els.cmdWrap.style.display = '';
    }

    async function runSimple(){
      const file = els.file.files[0];
      if(!file){ return Swal.fire('Pick a video first'); }

      await ensureFFmpeg();
      setProgress(0);
      els.out.style.display = 'none';

      const inputName = 'input.' + (file.name.split('.').pop() || 'mp4');
      const { args, out } = buildArgsSimple(inputName, 'output.mp4');
      showCmd(args);

      // Write input, run, read output
      ffmpeg.FS('writeFile', inputName, await fetchFile(file));
      logStatus('Compressing…');
      try{
        await ffmpeg.run(...args);
      }catch(err){
        console.error(err);
        Swal.fire('FFmpeg error', String(err), 'error');
        return;
      }

      const data = ffmpeg.FS('readFile', out);
      const blob = new Blob([data.buffer], { type: (out.endsWith('.webm') ? 'video/webm' : 'video/mp4') });
      const url = URL.createObjectURL(blob);
      els.dl.href = url;
      els.dl.download = out;
      els.size.textContent = `(${(blob.size/1024/1024).toFixed(2)} MB)`;
      els.out.style.display = 'flex';
      logStatus('Done.');
    }

    async function runAdvanced(){
      const file = els.file.files[0];
      if(!file){ return Swal.fire('Pick a video first'); }
      const cmdLine = els.advCmd.value.trim();
      if(!cmdLine){ return Swal.fire('Enter a command'); }

      await ensureFFmpeg();
      setProgress(0);
      els.out.style.display = 'none';

      const inputName = 'input.' + (file.name.split('.').pop() || 'mp4');
      ffmpeg.FS('writeFile', inputName, await fetchFile(file));

      // Replace placeholders if used
      const expanded = cmdLine
        .replace(/\bINPUT\b/g, inputName)
        .replace(/\bOUTPUT\b/g, 'output.mp4');

      // Split args (very simple split; quote-aware parsing would be overkill here)
      const args = expanded.split(/\s+/).filter(Boolean);
      showCmd(args);

      try{
        await ffmpeg.run(...args);
      }catch(err){
        console.error(err);
        Swal.fire('FFmpeg error', String(err), 'error');
        return;
      }

      const outName = args[args.length-1] || 'output.mp4';
      const data = ffmpeg.FS('readFile', outName);
      const blob = new Blob([data.buffer], { type: outName.endsWith('.webm') ? 'video/webm' : 'video/mp4' });
      const url = URL.createObjectURL(blob);
      els.dl.href = url;
      els.dl.download = outName;
      els.size.textContent = `(${(blob.size/1024/1024).toFixed(2)} MB)`;
      els.out.style.display = 'flex';
      logStatus('Done.');
    }

    els.start.onclick = runSimple;
    els.runAdv.onclick = runAdvanced;

    // Small UX niceties
    $('#file').on('change', () => { els.out.style.display='none'; setProgress(0); logStatus('Ready.'); });
  </script>
</body>
</html>
